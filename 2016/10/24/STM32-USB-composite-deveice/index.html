
 <!DOCTYPE HTML>
<html >
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
  
    <title>STM32 USB composite deveice | weyne&#39;s note</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="weyne">
    
    <meta name="description" content="目的
完成一个CDC +　MSC的复合USB设备
可以方便在CDC,MSC,复合设备三者间切换
可移植性强

预备知识cube中USB只有两个入口。

main函数中的MX_USB_DEVICE_Init函数。
123456789/* init function */void MX_USB_DEVI">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

  <body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="weyne&#39;s note" title="weyne&#39;s note"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="weyne&#39;s note">weyne&#39;s note</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">所有文章</a></li>
					
						<li><a href="/tags">标签</a></li>
					
						<li><a href="/categories">分类</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:weynechen.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/24/STM32-USB-composite-deveice/" title="STM32 USB composite deveice" itemprop="url">STM32 USB composite deveice</a>
  </h1>
  <p class="article-author">By
    
      <a href="weynechen.github.io" title="weyne">weyne</a>
    </p>
  <p class="article-time">
    <time datetime="2016-10-24T02:55:14.000Z" itemprop="datePublished">2016-10-24</time>
    Updated:<time datetime="2016-10-28T03:51:10.661Z" itemprop="dateModified">2016-10-28</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#目的"><span class="toc-number">1.</span> <span class="toc-text">目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预备知识"><span class="toc-number">2.</span> <span class="toc-text">预备知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-number">3.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改"><span class="toc-number">4.</span> <span class="toc-text">修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装驱动"><span class="toc-number">4.1.</span> <span class="toc-text">安装驱动</span></a></li></ol></li></ol>
		</div>
		
		<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><ul>
<li>完成一个CDC +　MSC的复合USB设备</li>
<li>可以方便在CDC,MSC,复合设备三者间切换</li>
<li>可移植性强</li>
</ul>
<h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><p>cube中USB只有两个入口。</p>
<ol>
<li><p>main函数中的MX_USB_DEVICE_Init函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* init function */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_USB_DEVICE_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* Init Device Library,Add Supported Class and Start the library*/</span></div><div class="line">  USBD_Init(&amp;hUsbDeviceFS, &amp;FS_Desc, DEVICE_FS);</div><div class="line">  USBD_RegisterClass(&amp;hUsbDeviceFS, &amp;USBD_COMPOSITE_CLASS);</div><div class="line">  USBD_MSC_RegisterStorage(&amp;hUsbDeviceFS, &amp;USBD_Storage_FS);</div><div class="line">  USBD_Start(&amp;hUsbDeviceFS);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>USB中断。USB的所有动作都是主机发起的，设备只是做响应。所以在cube中，所有的USB动作入口都是一个中断。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">USB_LP_CAN1_RX0_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* USER CODE BEGIN USB_LP_CAN1_RX0_IRQn 0 */</span></div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE END USB_LP_CAN1_RX0_IRQn 0 */</span></div><div class="line">  HAL_PCD_IRQHandler(&amp;hpcd_USB_FS);</div><div class="line">  <span class="comment">/* USER CODE BEGIN USB_LP_CAN1_RX0_IRQn 1 */</span></div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE END USB_LP_CAN1_RX0_IRQn 1 */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>看一下中断响应函数的内容<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  This function handles PCD interrupt request.</div><div class="line">  * @param  hpcd: PCD handle</div><div class="line">  * @retval HAL status</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_PCD_IRQHandler</span><span class="params">(PCD_HandleTypeDef *hpcd)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint32_t</span> wInterrupt_Mask = <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_CTR))</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* servicing of the endpoint correct transfer interrupt */</span></div><div class="line">    <span class="comment">/* clear of the CTR flag into the sub */</span></div><div class="line">    PCD_EP_ISR_Handler(hpcd);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_RESET))</div><div class="line">  &#123;</div><div class="line">    __HAL_PCD_CLEAR_FLAG(hpcd, USB_ISTR_RESET);</div><div class="line">    HAL_PCD_ResetCallback(hpcd);</div><div class="line">    HAL_PCD_SetAddress(hpcd, <span class="number">0</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_PMAOVR))</div><div class="line">  &#123;</div><div class="line">    __HAL_PCD_CLEAR_FLAG(hpcd, USB_ISTR_PMAOVR);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_ERR))</div><div class="line">  &#123;</div><div class="line">    __HAL_PCD_CLEAR_FLAG(hpcd, USB_ISTR_ERR);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_WKUP))</div><div class="line">  &#123;</div><div class="line">    hpcd-&gt;Instance-&gt;CNTR &amp;= ~(USB_CNTR_LP_MODE);</div><div class="line"></div><div class="line">    <span class="comment">/*set wInterrupt_Mask global variable*/</span></div><div class="line">    wInterrupt_Mask = USB_CNTR_CTRM  | USB_CNTR_WKUPM | USB_CNTR_SUSPM | USB_CNTR_ERRM \</div><div class="line">      | USB_CNTR_ESOFM | USB_CNTR_RESETM;</div><div class="line"></div><div class="line">    <span class="comment">/*Set interrupt mask*/</span></div><div class="line">    hpcd-&gt;Instance-&gt;CNTR = wInterrupt_Mask;</div><div class="line"></div><div class="line">    HAL_PCD_ResumeCallback(hpcd);</div><div class="line"></div><div class="line">    __HAL_PCD_CLEAR_FLAG(hpcd, USB_ISTR_WKUP);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_SUSP))</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* clear of the ISTR bit must be done after setting of CNTR_FSUSP */</span></div><div class="line">    __HAL_PCD_CLEAR_FLAG(hpcd, USB_ISTR_SUSP);</div><div class="line"></div><div class="line">    <span class="comment">/* Force low-power mode in the macrocell */</span></div><div class="line">    hpcd-&gt;Instance-&gt;CNTR |= USB_CNTR_FSUSP;</div><div class="line">    hpcd-&gt;Instance-&gt;CNTR |= USB_CNTR_LP_MODE;</div><div class="line">    <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_WKUP) == <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">      HAL_PCD_SuspendCallback(hpcd);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_SOF))</div><div class="line">  &#123;</div><div class="line">    __HAL_PCD_CLEAR_FLAG(hpcd, USB_ISTR_SOF);</div><div class="line">    HAL_PCD_SOFCallback(hpcd);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_ESOF))</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* clear ESOF flag in ISTR */</span></div><div class="line">    __HAL_PCD_CLEAR_FLAG(hpcd, USB_ISTR_ESOF);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出来，中断响应函数根据各个不同的中断源做出不同的操作。这点在参考手册也有提到<br><img src="usb_int_register.png" alt="usb_int_register"><br>在USB插入之后，主机开始进行枚举，复位USB，触发复位中断，会进入下面一个if语句。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (__HAL_PCD_GET_FLAG (hpcd, USB_ISTR_RESET))</div><div class="line">&#123;</div><div class="line">  __HAL_PCD_CLEAR_FLAG(hpcd, USB_ISTR_RESET);</div><div class="line">  HAL_PCD_ResetCallback(hpcd);</div><div class="line">  HAL_PCD_SetAddress(hpcd, <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这两个函数主要是设置总线速度，复位USB，以及设置USB地址。分析了这两个函数，基本了解了程序的流程，主要是两个关键的结构体<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  PCD Handle Structure definition</div><div class="line">  */</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">  PCD_TypeDef             *Instance;   <span class="comment">/*!&lt; Register base address               */</span></div><div class="line">  PCD_InitTypeDef         Init;        <span class="comment">/*!&lt; PCD required parameters             */</span></div><div class="line">  __IO <span class="keyword">uint8_t</span>            USB_Address; <span class="comment">/*!&lt; USB Address: not used by USB OTG FS */</span></div><div class="line">  PCD_EPTypeDef           IN_ep[<span class="number">15</span>];   <span class="comment">/*!&lt; IN endpoint parameters              */</span></div><div class="line">  PCD_EPTypeDef           OUT_ep[<span class="number">15</span>];  <span class="comment">/*!&lt; OUT endpoint parameters             */</span></div><div class="line">  HAL_LockTypeDef         Lock;        <span class="comment">/*!&lt; PCD peripheral status               */</span></div><div class="line">  __IO PCD_StateTypeDef   State;       <span class="comment">/*!&lt; PCD communication state             */</span></div><div class="line">  <span class="keyword">uint32_t</span>                Setup[<span class="number">12</span>];   <span class="comment">/*!&lt; Setup packet buffer                 */</span></div><div class="line">  <span class="keyword">void</span>                    *pData;      <span class="comment">/*!&lt; Pointer to upper stack Handler      */</span></div><div class="line">&#125; PCD_HandleTypeDef;</div><div class="line"></div><div class="line"><span class="comment">/* USB Device handle structure */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _USBD_HandleTypeDef</div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint8_t</span>                 id;</div><div class="line">  <span class="keyword">uint32_t</span>                dev_config;</div><div class="line">  <span class="keyword">uint32_t</span>                dev_default_config;</div><div class="line">  <span class="keyword">uint32_t</span>                dev_config_status;</div><div class="line">  USBD_SpeedTypeDef       dev_speed;</div><div class="line">  USBD_EndpointTypeDef    ep_in[<span class="number">15</span>];</div><div class="line">  USBD_EndpointTypeDef    ep_out[<span class="number">15</span>];</div><div class="line">  <span class="keyword">uint32_t</span>                ep0_state;</div><div class="line">  <span class="keyword">uint32_t</span>                ep0_data_len;</div><div class="line">  <span class="keyword">uint8_t</span>                 dev_state;</div><div class="line">  <span class="keyword">uint8_t</span>                 dev_old_state;</div><div class="line">  <span class="keyword">uint8_t</span>                 dev_address;</div><div class="line">  <span class="keyword">uint8_t</span>                 dev_connection_status;</div><div class="line">  <span class="keyword">uint8_t</span>                 dev_test_mode;</div><div class="line">  <span class="keyword">uint32_t</span>                dev_remote_wakeup;</div><div class="line"></div><div class="line">  USBD_SetupReqTypedef    request;</div><div class="line">  USBD_DescriptorsTypeDef *pDesc;</div><div class="line">  USBD_ClassTypeDef       *pClass;</div><div class="line">  <span class="keyword">void</span>                    *pClassData;</div><div class="line">  <span class="keyword">void</span>                    *pUserData;</div><div class="line">  <span class="keyword">void</span>                    *pData;</div><div class="line">&#125; USBD_HandleTypeDef;</div></pre></td></tr></table></figure></p>
<p>这两个结构体很关键，看下复位操作的函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  Reset callback.</div><div class="line">  * @param  hpcd: PCD handle</div><div class="line">  * @retval None</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_PCD_ResetCallback</span><span class="params">(PCD_HandleTypeDef *hpcd)</span></span></div><div class="line">&#123;</div><div class="line">  USBD_SpeedTypeDef speed = USBD_SPEED_FULL;</div><div class="line"></div><div class="line">  <span class="comment">/*Set USB Current Speed*/</span></div><div class="line">  <span class="keyword">switch</span> (hpcd-&gt;Init.speed)</div><div class="line">  &#123;</div><div class="line">  <span class="keyword">case</span> PCD_SPEED_FULL:</div><div class="line">    speed = USBD_SPEED_FULL;</div><div class="line">    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">  <span class="keyword">default</span>:</div><div class="line">    speed = USBD_SPEED_FULL;</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  USBD_LL_SetSpeed((USBD_HandleTypeDef*)hpcd-&gt;pData, speed);</div><div class="line"></div><div class="line">  <span class="comment">/*Reset Device*/</span></div><div class="line">  USBD_LL_Reset((USBD_HandleTypeDef*)hpcd-&gt;pData);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里有一个强制类型转换，将一个void指针强制转换为USBD_HandleTypeDef，那么这个指针必然一早就指向了一个实体的USBD_HandleTypeDef，向上追朔调用关系</p>
<blockquote>
<p>main-&gt;MX_USB_DEVICE_Init-&gt;USBD_Init-&gt;USBD_LL_Init-&gt;pdev-&gt;hpcd_USB_FS.pData = pdev</p>
</blockquote>
<p>然后，hpcd_USB_FS作为中断处理函数的参数被传进来。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* @brief  USBD_LL_Reset</div><div class="line">*         Handle Reset event</div><div class="line">* @param  pdev: device instance</div><div class="line">* @retval status</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="function">USBD_StatusTypeDef <span class="title">USBD_LL_Reset</span><span class="params">(USBD_HandleTypeDef  *pdev)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* Open EP0 OUT */</span></div><div class="line">  USBD_LL_OpenEP(pdev,</div><div class="line">              <span class="number">0x00</span>,</div><div class="line">              USBD_EP_TYPE_CTRL,</div><div class="line">              USB_MAX_EP0_SIZE);</div><div class="line"></div><div class="line">  pdev-&gt;ep_out[<span class="number">0</span>].maxpacket = USB_MAX_EP0_SIZE;</div><div class="line"></div><div class="line">  <span class="comment">/* Open EP0 IN */</span></div><div class="line">  USBD_LL_OpenEP(pdev,</div><div class="line">              <span class="number">0x80</span>,</div><div class="line">              USBD_EP_TYPE_CTRL,</div><div class="line">              USB_MAX_EP0_SIZE);</div><div class="line"></div><div class="line">  pdev-&gt;ep_in[<span class="number">0</span>].maxpacket = USB_MAX_EP0_SIZE;</div><div class="line">  <span class="comment">/* Upon Reset call user call back */</span></div><div class="line">  pdev-&gt;dev_state = USBD_STATE_DEFAULT;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (pdev-&gt;pClassData)</div><div class="line">    pdev-&gt;pClass-&gt;DeInit(pdev, pdev-&gt;dev_config);</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">return</span> USBD_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* @brief  USBD_LL_Reset</div><div class="line">*         Handle Reset event</div><div class="line">* @param  pdev: device instance</div><div class="line">* @retval status</div><div class="line">*/</div><div class="line"><span class="function">USBD_StatusTypeDef <span class="title">USBD_LL_SetSpeed</span><span class="params">(USBD_HandleTypeDef  *pdev, USBD_SpeedTypeDef speed)</span></span></div><div class="line">&#123;</div><div class="line">  pdev-&gt;dev_speed = speed;</div><div class="line">  <span class="keyword">return</span> USBD_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SetSpeed比较简单，只是将hUsbDeviceFs中的dev_speed设置一下。<br>Reset函数则是将端点0的IN OUT端点打开，然后有一句</p>
<blockquote>
<p>pdev-&gt;pClass-&gt;DeInit(pdev,pdev-&gt;dev_config)</p>
</blockquote>
<p>这里又是一个USBD_ClassTypeDef类型的指针<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _Device_cb</div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint8_t</span>  (*Init)             (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev , <span class="keyword">uint8_t</span> cfgidx);</div><div class="line">  <span class="keyword">uint8_t</span>  (*DeInit)           (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev , <span class="keyword">uint8_t</span> cfgidx);</div><div class="line"> <span class="comment">/* Control Endpoints*/</span></div><div class="line">  <span class="keyword">uint8_t</span>  (*Setup)            (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev , USBD_SetupReqTypedef  *req);</div><div class="line">  <span class="keyword">uint8_t</span>  (*EP0_TxSent)       (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev );</div><div class="line">  <span class="keyword">uint8_t</span>  (*EP0_RxReady)      (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev );</div><div class="line">  <span class="comment">/* Class Specific Endpoints*/</span></div><div class="line">  <span class="keyword">uint8_t</span>  (*DataIn)           (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev , <span class="keyword">uint8_t</span> epnum);</div><div class="line">  <span class="keyword">uint8_t</span>  (*DataOut)          (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev , <span class="keyword">uint8_t</span> epnum);</div><div class="line">  <span class="keyword">uint8_t</span>  (*SOF)              (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev);</div><div class="line">  <span class="keyword">uint8_t</span>  (*IsoINIncomplete)  (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev , <span class="keyword">uint8_t</span> epnum);</div><div class="line">  <span class="keyword">uint8_t</span>  (*IsoOUTIncomplete) (<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev , <span class="keyword">uint8_t</span> epnum);</div><div class="line"></div><div class="line">  <span class="keyword">uint8_t</span>  *(*GetHSConfigDescriptor)(<span class="keyword">uint16_t</span> *length);</div><div class="line">  <span class="keyword">uint8_t</span>  *(*GetFSConfigDescriptor)(<span class="keyword">uint16_t</span> *length);</div><div class="line">  <span class="keyword">uint8_t</span>  *(*GetOtherSpeedConfigDescriptor)(<span class="keyword">uint16_t</span> *length);</div><div class="line">  <span class="keyword">uint8_t</span>  *(*GetDeviceQualifierDescriptor)(<span class="keyword">uint16_t</span> *length);</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> (USBD_SUPPORT_USER_STRING == 1)</span></div><div class="line">  <span class="keyword">uint8_t</span>  *(*GetUsrStrDescriptor)(<span class="keyword">struct</span> _USBD_HandleTypeDef *pdev ,<span class="keyword">uint8_t</span> index,  <span class="keyword">uint16_t</span> *length);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">&#125; USBD_ClassTypeDef;</div></pre></td></tr></table></figure></p>
<p>可以看到这个类定义都是函数指针，在调用之前必定实例化(借用面向对象来词汇)过。</p>
<blockquote>
<p>main -&gt; MX_USB_DEVICE_Init-&gt;USBD_RegisterClass-&gt;pdev-&gt;pClass=pclass</p>
</blockquote>
<p>如果是CDC类，那么最终指向的是在usbd_cdc.c中的USBD_CDC类，如果是复合类，那么就需要我们自己定义。<br>在调用DeInit过程中，又会调用两个void 指针：pclassData,pUserData<br>其中pClassData是初始化是在初始化各个类的时候，比如</p>
<ul>
<li>MSC类</li>
</ul>
<blockquote>
<p>USBD_MSC_Init -&gt;  pdev-&gt;pClassData = USBD_malloc(sizeof (USBD_MSC_BOT_HandleTypeDef));</p>
</blockquote>
<ul>
<li>CDC类</li>
</ul>
<blockquote>
<p>USBD_CDC_Init -&gt;   pdev-&gt;pClassData = USBD_malloc(sizeof (USBD_CDC_HandleTypeDef));</p>
</blockquote>
<p>不同的类，指向不同的函数指针。</p>
<p>pUserData是通过一个函数初始化，比如CDC类</p>
<blockquote>
<p>main -&gt; USBD_CDC_RegisterInterface(&amp;hUsbDeviceFS, &amp;USBD_Interface_fops_FS);</p>
</blockquote>
<p>USBD_Interface_fops_FS定义如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _USBD_CDC_Itf</div><div class="line">&#123;</div><div class="line">  <span class="keyword">int8_t</span> (* Init)          (<span class="keyword">void</span>);</div><div class="line">  <span class="keyword">int8_t</span> (* DeInit)        (<span class="keyword">void</span>);</div><div class="line">  <span class="keyword">int8_t</span> (* Control)       (<span class="keyword">uint8_t</span>, <span class="keyword">uint8_t</span> * , <span class="keyword">uint16_t</span>);</div><div class="line">  <span class="keyword">int8_t</span> (* Receive)       (<span class="keyword">uint8_t</span> *, <span class="keyword">uint32_t</span> *);</div><div class="line"></div><div class="line">&#125;USBD_CDC_ItfTypeDef;</div></pre></td></tr></table></figure></p>
<p>pClassData和pUserData在USBD_HandleTypeDef中是指针形式，所以在调用不同类的时候，改变指针的指向，即可完成不同类的功能。我们复合设备类的设计思想既是如此。</p>
<p>可以总结一下 USBD_HandleTypeDef中几个复杂的指针<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">USBD_DescriptorsTypeDef *pDesc;</div><div class="line"> USBD_ClassTypeDef       *pClass;</div><div class="line"> <span class="keyword">void</span>                    *pClassData;</div><div class="line"> <span class="keyword">void</span>                    *pUserData;</div><div class="line"> <span class="keyword">void</span>                    *pData;</div></pre></td></tr></table></figure></p>
<ul>
<li><b style="color:red">pDesc指向描述符的数组，在枚举阶段启用</b></li>
<li><b style="color:red">pClass指向设备类，比如CDC类的USBD_ClassTypeDef，负责类的底层Init,Setup,DataIn/Out等</b></li>
<li><b style="color:red">pClassData指向设备类句柄，负责记录数据，比如RxBuffer,TxBuffer,RxLength等</b></li>
<li><b style="color:red">pUserData指向设备类的接口操作函数，比如CDC的Init,Receive,Transmit，比如MSC的Read，Write等</b></li>
<li><b style="color:red">pData指向hpcd_USB_FS</b></li>
</ul>
<p>注意点：</p>
<ol>
<li><p><b style="color:blue">pClassData要在堆上动态生成，不能调用静态分配函数，否则两次分配会被分配到同一段内存中</b></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_malloc               malloc</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_free                 free</span></div></pre></td></tr></table></figure>
</li>
<li><p>在pClass-&gt;Init之后，pClassData分配完成，此时需要一个全局指针将这个pClassData记录下来</p>
</li>
<li>在pClass-&gt;DeInit时，pClassData根据不同的类读回之前的全局指针,然后free掉堆上的内存</li>
<li><b style="color:blue">由于使用了两次malloc所以heap_size要分配足够大，同时也要注意修改stack_size。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Stack_Size EQU 0x1000</div><div class="line">Heap_Size  EQU 0x800</div></pre></td></tr></table></figure>
</b></li>
</ol>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>利用cube生成一个CDC工程和一个MSC工程，将CDC工程中的usbd_cdc以及usbd_cdc_if文件拷贝出来。</li>
<li>修改都在MSC工程下面完成。在工程下建立一个USBConfig文件夹，将之前拷贝的文件以及其他USB配置相关的文件放到这个文件夹下面。</li>
<li>新建一个usbd_composite.c，usbd_composite.h，添加到工程。整体文件结构如下：</li>
</ol>
<p><img src="filestructure.png" alt="filestructure"></p>
<p><img src="class.png" alt="class"></p>
<p><img src="keil.png" alt="keil"></p>
<ol>
<li>编译(注意添加头文件路径)</li>
</ol>
<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><ol>
<li>分配好端点号</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#define CDC_IN_EP                                   0x81  /* EP1 for data IN */</div><div class="line">#define CDC_OUT_EP                                  0x01  /* EP1 for data OUT */</div><div class="line">#define CDC_CMD_EP                                  0x83  /* EP3 for CDC commands */</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#define MSC_EPIN_ADDR                0x82</div><div class="line">#define MSC_EPOUT_ADDR               0x02</div></pre></td></tr></table></figure>
<ol>
<li>将如下内容添加到usbd_composite.c以及usbdcomposite.h<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * @file        usbd_composite.c</div><div class="line"> * @author      Weyne</div><div class="line"> * @version     V01</div><div class="line"> * @date        2016.10.28</div><div class="line"> * @brief       MSC + CDC 复合设备</div><div class="line"> * @note</div><div class="line"> * @attention   COYPRIGHT WEYNE</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usbd_composite.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usbd_cdc.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usbd_msc.h"</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> USBD_CDC_HandleTypeDef *pCDCData;</div><div class="line"><span class="keyword">static</span> USBD_MSC_BOT_HandleTypeDef *pMSCData;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_Init</span> <span class="params">(USBD_HandleTypeDef *pdev,</span></span></div><div class="line">                            <span class="keyword">uint8_t</span> cfgidx);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_DeInit</span> <span class="params">(USBD_HandleTypeDef *pdev,</span></span></div><div class="line">                              <span class="keyword">uint8_t</span> cfgidx);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_EP0_RxReady</span><span class="params">(USBD_HandleTypeDef *pdev)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_Setup</span> <span class="params">(USBD_HandleTypeDef *pdev,</span></span></div><div class="line">                             USBD_SetupReqTypedef *req);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_DataIn</span> <span class="params">(USBD_HandleTypeDef *pdev,</span></span></div><div class="line">                              <span class="keyword">uint8_t</span> epnum);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_DataOut</span> <span class="params">(USBD_HandleTypeDef *pdev,</span></span></div><div class="line">                               <span class="keyword">uint8_t</span> epnum);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  *<span class="title">USBD_Composite_GetFSCfgDesc</span> <span class="params">(<span class="keyword">uint16_t</span> *length)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  *<span class="title">USBD_Composite_GetDeviceQualifierDescriptor</span> <span class="params">(<span class="keyword">uint16_t</span> *length)</span></span>;</div><div class="line"></div><div class="line">USBD_ClassTypeDef  USBD_COMPOSITE =</div><div class="line">&#123;</div><div class="line">  USBD_Composite_Init,</div><div class="line">  USBD_Composite_DeInit,</div><div class="line">  USBD_Composite_Setup,</div><div class="line">  <span class="literal">NULL</span>, <span class="comment">/*EP0_TxSent*/</span></div><div class="line">  USBD_Composite_EP0_RxReady,</div><div class="line">  USBD_Composite_DataIn,</div><div class="line">  USBD_Composite_DataOut,</div><div class="line">  <span class="literal">NULL</span>,</div><div class="line">  <span class="literal">NULL</span>,</div><div class="line">  <span class="literal">NULL</span>,</div><div class="line">  <span class="literal">NULL</span>,</div><div class="line">  USBD_Composite_GetFSCfgDesc,</div><div class="line">  <span class="literal">NULL</span>,</div><div class="line">  USBD_Composite_GetDeviceQualifierDescriptor,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/* USB composite device Configuration Descriptor */</span></div><div class="line"><span class="comment">/*   All Descriptors (Configuration, Interface, Endpoint, Class, Vendor */</span></div><div class="line">__ALIGN_BEGIN <span class="keyword">uint8_t</span> USBD_Composite_CfgFSDesc[USBD_COMPOSITE_DESC_SIZE]  __ALIGN_END =</div><div class="line">&#123;</div><div class="line">  <span class="number">0x09</span>,   <span class="comment">/* bLength: Configuation Descriptor size */</span></div><div class="line">  USB_DESC_TYPE_CONFIGURATION,   <span class="comment">/* bDescriptorType: Configuration */</span></div><div class="line">  WBVAL(USBD_COMPOSITE_DESC_SIZE),</div><div class="line">  USBD_MAX_NUM_INTERFACES ,  <span class="comment">/* bNumInterfaces: */</span></div><div class="line">  <span class="number">0x01</span>,   <span class="comment">/* bConfigurationValue: */</span></div><div class="line">  <span class="number">0x04</span>,   <span class="comment">/* iConfiguration: */</span></div><div class="line">  <span class="number">0xC0</span>,   <span class="comment">/* bmAttributes: */</span></div><div class="line">  <span class="number">0x96</span>,   <span class="comment">/* MaxPower 300 mA */</span></div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">/****************************CDC************************************/</span></div><div class="line">  <span class="comment">/* Interface Association Descriptor */</span></div><div class="line">  USBD_IAD_DESC_SIZE,               <span class="comment">// bLength</span></div><div class="line">  USBD_IAD_DESCRIPTOR_TYPE,         <span class="comment">// bDescriptorType</span></div><div class="line">  USBD_CDC_FIRST_INTERFACE,         <span class="comment">// bFirstInterface</span></div><div class="line">  USBD_CDC_INTERFACE_NUM,           <span class="comment">// bInterfaceCount</span></div><div class="line">  <span class="number">0x02</span>,                             <span class="comment">// bFunctionClass</span></div><div class="line">  <span class="number">0x02</span>,                             <span class="comment">// bFunctionSubClass</span></div><div class="line">  <span class="number">0x01</span>,                             <span class="comment">// bInterfaceProtocol</span></div><div class="line">  <span class="number">0x04</span>,                             <span class="comment">// iFunction</span></div><div class="line"></div><div class="line">  <span class="comment">/*Interface Descriptor */</span></div><div class="line">  <span class="number">0x09</span>,   <span class="comment">/* bLength: Interface Descriptor size */</span></div><div class="line">  USB_DESC_TYPE_INTERFACE,  <span class="comment">/* bDescriptorType: Interface */</span></div><div class="line">  <span class="comment">/* Interface descriptor type */</span></div><div class="line">  USBD_CDC_CMD_INTERFACE,   <span class="comment">/* bInterfaceNumber: Number of Interface */</span></div><div class="line">  <span class="number">0x00</span>,   <span class="comment">/* bAlternateSetting: Alternate setting */</span></div><div class="line">  <span class="number">0x01</span>,   <span class="comment">/* bNumEndpoints: One endpoints used */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/* bInterfaceClass: Communication Interface Class */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/* bInterfaceSubClass: Abstract Control Model */</span></div><div class="line">  <span class="number">0x01</span>,   <span class="comment">/* bInterfaceProtocol: Common AT commands */</span></div><div class="line">  <span class="number">0x01</span>,   <span class="comment">/* iInterface: */</span></div><div class="line"></div><div class="line">  <span class="comment">/*Header Functional Descriptor*/</span></div><div class="line">  <span class="number">0x05</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></div><div class="line">  <span class="number">0x24</span>,   <span class="comment">/* bDescriptorType: CS_INTERFACE */</span></div><div class="line">  <span class="number">0x00</span>,   <span class="comment">/* bDescriptorSubtype: Header Func Desc */</span></div><div class="line">  <span class="number">0x10</span>,   <span class="comment">/* bcdCDC: spec release number */</span></div><div class="line">  <span class="number">0x01</span>,</div><div class="line"></div><div class="line">  <span class="comment">/*Call Management Functional Descriptor*/</span></div><div class="line">  <span class="number">0x05</span>,   <span class="comment">/* bFunctionLength */</span></div><div class="line">  <span class="number">0x24</span>,   <span class="comment">/* bDescriptorType: CS_INTERFACE */</span></div><div class="line">  <span class="number">0x01</span>,   <span class="comment">/* bDescriptorSubtype: Call Management Func Desc */</span></div><div class="line">  <span class="number">0x00</span>,   <span class="comment">/* bmCapabilities: D0+D1 */</span></div><div class="line">  <span class="number">0x01</span>,   <span class="comment">/* bDataInterface: 1 */</span></div><div class="line"></div><div class="line">  <span class="comment">/*ACM Functional Descriptor*/</span></div><div class="line">  <span class="number">0x04</span>,   <span class="comment">/* bFunctionLength */</span></div><div class="line">  <span class="number">0x24</span>,   <span class="comment">/* bDescriptorType: CS_INTERFACE */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/* bDescriptorSubtype: Abstract Control Management desc */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/* bmCapabilities */</span></div><div class="line"></div><div class="line">  <span class="comment">/*Union Functional Descriptor*/</span></div><div class="line">  <span class="number">0x05</span>,   <span class="comment">/* bFunctionLength */</span></div><div class="line">  <span class="number">0x24</span>,   <span class="comment">/* bDescriptorType: CS_INTERFACE */</span></div><div class="line">  <span class="number">0x06</span>,   <span class="comment">/* bDescriptorSubtype: Union func desc */</span></div><div class="line">  USBD_CDC_CMD_INTERFACE,   <span class="comment">/* bMasterInterface: Communication class interface */</span></div><div class="line">  USBD_CDC_DATA_INTERFACE,   <span class="comment">/* bSlaveInterface0: Data Class Interface */</span></div><div class="line"></div><div class="line">  <span class="comment">/*Endpoint 2 Descriptor*/</span></div><div class="line">  <span class="number">0x07</span>,                           <span class="comment">/* bLength: Endpoint Descriptor size */</span></div><div class="line">  USB_DESC_TYPE_ENDPOINT,   <span class="comment">/* bDescriptorType: Endpoint */</span></div><div class="line">  CDC_CMD_EP,                     <span class="comment">/* bEndpointAddress */</span></div><div class="line">  <span class="number">0x03</span>,                           <span class="comment">/* bmAttributes: Interrupt */</span></div><div class="line">  LOBYTE(CDC_CMD_PACKET_SIZE),     <span class="comment">/* wMaxPacketSize: */</span></div><div class="line">  HIBYTE(CDC_CMD_PACKET_SIZE),</div><div class="line">  <span class="number">0x01</span>,                           <span class="comment">/* bInterval: */</span></div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">/*Data class interface descriptor*/</span></div><div class="line">  <span class="number">0x09</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></div><div class="line">  USB_DESC_TYPE_INTERFACE,  <span class="comment">/* bDescriptorType: */</span></div><div class="line">  USBD_CDC_DATA_INTERFACE,   <span class="comment">/* bInterfaceNumber: Number of Interface */</span></div><div class="line">  <span class="number">0x00</span>,   <span class="comment">/* bAlternateSetting: Alternate setting */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/* bNumEndpoints: Two endpoints used */</span></div><div class="line">  <span class="number">0x0A</span>,   <span class="comment">/* bInterfaceClass: CDC */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/* bInterfaceSubClass: */</span></div><div class="line">  <span class="number">0x00</span>,   <span class="comment">/* bInterfaceProtocol: */</span></div><div class="line">  <span class="number">0x01</span>,   <span class="comment">/* iInterface: */</span></div><div class="line"></div><div class="line">  <span class="comment">/*Endpoint OUT Descriptor*/</span></div><div class="line">  <span class="number">0x07</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></div><div class="line">  USB_DESC_TYPE_ENDPOINT,      <span class="comment">/* bDescriptorType: Endpoint */</span></div><div class="line">  CDC_OUT_EP,                        <span class="comment">/* bEndpointAddress */</span></div><div class="line">  <span class="number">0x02</span>,                              <span class="comment">/* bmAttributes: Bulk */</span></div><div class="line">  LOBYTE(CDC_DATA_FS_MAX_PACKET_SIZE),  <span class="comment">/* wMaxPacketSize: */</span></div><div class="line">  HIBYTE(CDC_DATA_FS_MAX_PACKET_SIZE),</div><div class="line">  <span class="number">0x01</span>,                              <span class="comment">/* bInterval: ignore for Bulk transfer */</span></div><div class="line"></div><div class="line">  <span class="comment">/*Endpoint IN Descriptor*/</span></div><div class="line">  <span class="number">0x07</span>,   <span class="comment">/* bLength: Endpoint Descriptor size */</span></div><div class="line">  USB_DESC_TYPE_ENDPOINT,      <span class="comment">/* bDescriptorType: Endpoint */</span></div><div class="line">  CDC_IN_EP,                         <span class="comment">/* bEndpointAddress */</span></div><div class="line">  <span class="number">0x02</span>,                              <span class="comment">/* bmAttributes: Bulk */</span></div><div class="line">  LOBYTE(CDC_DATA_FS_MAX_PACKET_SIZE),  <span class="comment">/* wMaxPacketSize: */</span></div><div class="line">  HIBYTE(CDC_DATA_FS_MAX_PACKET_SIZE),</div><div class="line">  <span class="number">0x01</span>,                               <span class="comment">/* bInterval: ignore for Bulk transfer */</span></div><div class="line"></div><div class="line"></div><div class="line"> <span class="comment">/****************************MSC************************************/</span></div><div class="line">  <span class="comment">/* Interface Association Descriptor */</span></div><div class="line">  USBD_IAD_DESC_SIZE,                        <span class="comment">// bLength</span></div><div class="line">  USBD_IAD_DESCRIPTOR_TYPE,                  <span class="comment">// bDescriptorType</span></div><div class="line">  USBD_MSC_FIRST_INTERFACE,                  <span class="comment">// bFirstInterface</span></div><div class="line">  USBD_MSC_INTERFACE_NUM,                    <span class="comment">// bInterfaceCount</span></div><div class="line">  <span class="number">0x08</span>,                                      <span class="comment">// bFunctionClass</span></div><div class="line">  <span class="number">0x06</span>,                                      <span class="comment">// bFunctionSubClass</span></div><div class="line">  <span class="number">0x50</span>,                                      <span class="comment">// bInterfaceProtocol</span></div><div class="line">  <span class="number">0x05</span>,</div><div class="line"></div><div class="line">  <span class="comment">/********************  Mass Storage interface ********************/</span></div><div class="line">  <span class="number">0x09</span>,   <span class="comment">/* bLength: Interface Descriptor size */</span></div><div class="line">  USB_DESC_TYPE_INTERFACE,   <span class="comment">/* bDescriptorType: */</span></div><div class="line">  USBD_MSC_INTERFACE,   <span class="comment">/* bInterfaceNumber: Number of Interface */</span></div><div class="line">  <span class="number">0x00</span>,   <span class="comment">/* bAlternateSetting: Alternate setting */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/* bNumEndpoints*/</span></div><div class="line">  <span class="number">0x08</span>,   <span class="comment">/* bInterfaceClass: MSC Class */</span></div><div class="line">  <span class="number">0x06</span>,   <span class="comment">/* bInterfaceSubClass : SCSI transparent*/</span></div><div class="line">  <span class="number">0x50</span>,   <span class="comment">/* nInterfaceProtocol */</span></div><div class="line">  <span class="number">0x05</span>,          <span class="comment">/* iInterface: */</span></div><div class="line"></div><div class="line">  <span class="comment">/********************  Mass Storage Endpoints ********************/</span></div><div class="line">  <span class="number">0x07</span>,   <span class="comment">/*Endpoint descriptor length = 7*/</span></div><div class="line">  <span class="number">0x05</span>,   <span class="comment">/*Endpoint descriptor type */</span></div><div class="line">  MSC_EPIN_ADDR,   <span class="comment">/*Endpoint address (IN, address 1) */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/*Bulk endpoint type */</span></div><div class="line">  LOBYTE(MSC_MAX_FS_PACKET),</div><div class="line">  HIBYTE(MSC_MAX_FS_PACKET),</div><div class="line">  <span class="number">0x01</span>,   <span class="comment">/*Polling interval in milliseconds */</span></div><div class="line"></div><div class="line">  <span class="number">0x07</span>,   <span class="comment">/*Endpoint descriptor length = 7 */</span></div><div class="line">  <span class="number">0x05</span>,   <span class="comment">/*Endpoint descriptor type */</span></div><div class="line">  MSC_EPOUT_ADDR,   <span class="comment">/*Endpoint address (OUT, address 1) */</span></div><div class="line">  <span class="number">0x02</span>,   <span class="comment">/*Bulk endpoint type */</span></div><div class="line">  LOBYTE(MSC_MAX_FS_PACKET),</div><div class="line">  HIBYTE(MSC_MAX_FS_PACKET),</div><div class="line">  <span class="number">0x01</span>,     <span class="comment">/*Polling interval in milliseconds*/</span></div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* USB Standard Device Descriptor */</span></div><div class="line">__ALIGN_BEGIN  <span class="keyword">uint8_t</span> USBD_Composite_DeviceQualifierDesc[USB_LEN_DEV_QUALIFIER_DESC]  __ALIGN_END =</div><div class="line">&#123;</div><div class="line">  USB_LEN_DEV_QUALIFIER_DESC,</div><div class="line">  USB_DESC_TYPE_DEVICE_QUALIFIER,</div><div class="line">  <span class="number">0x00</span>,</div><div class="line">  <span class="number">0x02</span>,</div><div class="line">  <span class="number">0x00</span>,</div><div class="line">  <span class="number">0x00</span>,</div><div class="line">  <span class="number">0x00</span>,</div><div class="line">  <span class="number">0x40</span>,</div><div class="line">  <span class="number">0x01</span>,</div><div class="line">  <span class="number">0x00</span>,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  USBD_Composite_Init</div><div class="line">  *         Initialize the Composite interface</div><div class="line">  * @param  pdev: device instance</div><div class="line">  * @param  cfgidx: Configuration index</div><div class="line">  * @retval status</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_Init</span> <span class="params">(USBD_HandleTypeDef *pdev,</span></span></div><div class="line">                            <span class="keyword">uint8_t</span> cfgidx)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint8_t</span> res = <span class="number">0</span>;</div><div class="line"></div><div class="line">  pdev-&gt;pUserData =  &amp;USBD_CDC_Interface_fops_FS;</div><div class="line">  res +=  USBD_CDC.Init(pdev,cfgidx);</div><div class="line">  pCDCData = pdev-&gt;pClassData;</div><div class="line">  pdev-&gt;pUserData = &amp;USBD_Storage_Interface_fops_FS;</div><div class="line">  res +=  USBD_MSC.Init(pdev,cfgidx);</div><div class="line">  pMSCData = pdev-&gt;pClassData;</div><div class="line">  <span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  USBD_Composite_DeInit</div><div class="line">  *         DeInitilaize  the Composite configuration</div><div class="line">  * @param  pdev: device instance</div><div class="line">  * @param  cfgidx: configuration index</div><div class="line">  * @retval status</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_DeInit</span> <span class="params">(USBD_HandleTypeDef *pdev,</span></span></div><div class="line">                              <span class="keyword">uint8_t</span> cfgidx)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">uint8_t</span> res = <span class="number">0</span>;</div><div class="line">	pdev-&gt;pClassData = pCDCData;</div><div class="line">	pdev-&gt;pUserData = &amp;USBD_CDC_Interface_fops_FS;</div><div class="line">	res +=  USBD_CDC.DeInit(pdev,cfgidx);</div><div class="line"></div><div class="line">	pdev-&gt;pClassData = pMSCData;</div><div class="line">	pdev-&gt;pUserData = &amp;USBD_Storage_Interface_fops_FS;</div><div class="line">	res +=  USBD_MSC.DeInit(pdev,cfgidx);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_EP0_RxReady</span><span class="params">(USBD_HandleTypeDef *pdev)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> USBD_CDC.EP0_RxReady(pdev);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* @brief  USBD_Composite_Setup</div><div class="line">*         Handle the Composite requests</div><div class="line">* @param  pdev: device instance</div><div class="line">* @param  req: USB request</div><div class="line">* @retval status</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">static</span> uint8_t  <span class="title">USBD_Composite_Setup</span> <span class="params">(USBD_HandleTypeDef *pdev, USBD_SetupReqTypedef *req)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">switch</span> (req-&gt;bmRequest &amp; USB_REQ_RECIPIENT_MASK)</div><div class="line">  &#123;</div><div class="line">   <span class="keyword">case</span> USB_REQ_RECIPIENT_INTERFACE:</div><div class="line">     <span class="keyword">switch</span>(req-&gt;wIndex)</div><div class="line">      &#123;</div><div class="line">         <span class="keyword">case</span> USBD_CDC_DATA_INTERFACE:</div><div class="line">         <span class="keyword">case</span> USBD_CDC_CMD_INTERFACE:</div><div class="line">			 pdev-&gt;pClassData = pCDCData;</div><div class="line">			 pdev-&gt;pUserData =  &amp;USBD_CDC_Interface_fops_FS;</div><div class="line">           <span class="keyword">return</span>(USBD_CDC.Setup(pdev, req));</div><div class="line"></div><div class="line">         <span class="keyword">case</span> USBD_MSC_INTERFACE:</div><div class="line">			 pdev-&gt;pClassData = pMSCData;</div><div class="line">			 pdev-&gt;pUserData =  &amp;USBD_Storage_Interface_fops_FS;</div><div class="line">           <span class="keyword">return</span>(USBD_MSC.Setup (pdev, req));</div><div class="line"></div><div class="line">         <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">break</span>;</div><div class="line"></div><div class="line">   <span class="keyword">case</span> USB_REQ_RECIPIENT_ENDPOINT:</div><div class="line">     <span class="keyword">switch</span>(req-&gt;wIndex)</div><div class="line">     &#123;</div><div class="line"></div><div class="line">         <span class="keyword">case</span> CDC_IN_EP:</div><div class="line">         <span class="keyword">case</span> CDC_OUT_EP:</div><div class="line">         <span class="keyword">case</span> CDC_CMD_EP:</div><div class="line">			 pdev-&gt;pClassData = pCDCData;</div><div class="line">			 pdev-&gt;pUserData =  &amp;USBD_CDC_Interface_fops_FS;</div><div class="line">           <span class="keyword">return</span>(USBD_CDC.Setup(pdev, req));</div><div class="line"></div><div class="line">         <span class="keyword">case</span> MSC_EPIN_ADDR:</div><div class="line">         <span class="keyword">case</span> MSC_EPOUT_ADDR:</div><div class="line">			 pdev-&gt;pClassData = pMSCData;</div><div class="line">			 pdev-&gt;pUserData =  &amp;USBD_Storage_Interface_fops_FS;</div><div class="line">           <span class="keyword">return</span>(USBD_MSC.Setup (pdev, req));</div><div class="line"></div><div class="line">         <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> USBD_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* @brief  USBD_Composite_DataIn</div><div class="line">*         handle data IN Stage</div><div class="line">* @param  pdev: device instance</div><div class="line">* @param  epnum: endpoint index</div><div class="line">* @retval status</div><div class="line">*/</div><div class="line"><span class="keyword">uint8_t</span>  USBD_Composite_DataIn (USBD_HandleTypeDef *pdev,</div><div class="line">                              <span class="keyword">uint8_t</span> epnum)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">switch</span>(epnum)</div><div class="line">  &#123;</div><div class="line">      <span class="keyword">case</span> CDC_INDATA_NUM:</div><div class="line">		pdev-&gt;pClassData = pCDCData;</div><div class="line">		pdev-&gt;pUserData =  &amp;USBD_CDC_Interface_fops_FS;</div><div class="line">         <span class="keyword">return</span>(USBD_CDC.DataIn(pdev,epnum));</div><div class="line"></div><div class="line">      <span class="keyword">case</span> MSC_INDATA_NUM:</div><div class="line">			 pdev-&gt;pClassData = pMSCData;</div><div class="line">			 pdev-&gt;pUserData =  &amp;USBD_Storage_Interface_fops_FS;</div><div class="line">         <span class="keyword">return</span>(USBD_MSC.DataIn(pdev,epnum));</div><div class="line"></div><div class="line">      <span class="keyword">default</span>:</div><div class="line">         <span class="keyword">break</span>;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> USBD_FAIL;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* @brief  USBD_Composite_DataOut</div><div class="line">*         handle data OUT Stage</div><div class="line">* @param  pdev: device instance</div><div class="line">* @param  epnum: endpoint index</div><div class="line">* @retval status</div><div class="line">*/</div><div class="line"><span class="keyword">uint8_t</span>  USBD_Composite_DataOut (USBD_HandleTypeDef *pdev,</div><div class="line">                               <span class="keyword">uint8_t</span> epnum)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">switch</span>(epnum)</div><div class="line">  &#123;</div><div class="line">      <span class="keyword">case</span> CDC_OUTDATA_NUM:</div><div class="line">      <span class="keyword">case</span> CDC_OUTCMD_NUM:</div><div class="line">		pdev-&gt;pClassData = pCDCData;</div><div class="line">		pdev-&gt;pUserData =  &amp;USBD_CDC_Interface_fops_FS;</div><div class="line">         <span class="keyword">return</span>(USBD_CDC.DataOut(pdev,epnum));</div><div class="line"></div><div class="line">      <span class="keyword">case</span> MSC_OUTDATA_NUM:</div><div class="line">			 pdev-&gt;pClassData = pMSCData;</div><div class="line">			 pdev-&gt;pUserData =  &amp;USBD_Storage_Interface_fops_FS;</div><div class="line">         <span class="keyword">return</span>(USBD_MSC.DataOut(pdev,epnum));</div><div class="line"></div><div class="line">      <span class="keyword">default</span>:</div><div class="line">         <span class="keyword">break</span>;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> USBD_FAIL;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* @brief  USBD_Composite_GetHSCfgDesc</div><div class="line">*         return configuration descriptor</div><div class="line">* @param  length : pointer data length</div><div class="line">* @retval pointer to descriptor buffer</div><div class="line">*/</div><div class="line"><span class="keyword">uint8_t</span>  *USBD_Composite_GetFSCfgDesc (<span class="keyword">uint16_t</span> *length)</div><div class="line">&#123;</div><div class="line">   *length = <span class="keyword">sizeof</span> (USBD_Composite_CfgFSDesc);</div><div class="line">   <span class="keyword">return</span> USBD_Composite_CfgFSDesc;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* @brief  DeviceQualifierDescriptor</div><div class="line">*         return Device Qualifier descriptor</div><div class="line">* @param  length : pointer data length</div><div class="line">* @retval pointer to descriptor buffer</div><div class="line">*/</div><div class="line"><span class="keyword">uint8_t</span>  *USBD_Composite_GetDeviceQualifierDescriptor (<span class="keyword">uint16_t</span> *length)</div><div class="line">&#123;</div><div class="line">  *length = <span class="keyword">sizeof</span> (USBD_Composite_DeviceQualifierDesc);</div><div class="line">  <span class="keyword">return</span> USBD_Composite_DeviceQualifierDesc;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @&#125;</div><div class="line">  */</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @&#125;</div><div class="line">  */</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @&#125;</div><div class="line">  */</div><div class="line"></div><div class="line"><span class="comment">/************************ (C) COPYRIGHT WEYNE *****END OF FILE****/</span></div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * @file        usbd_composite.h</div><div class="line"> * @author      Weyne</div><div class="line"> * @version     V01</div><div class="line"> * @date        2016.10.28</div><div class="line"> * @brief       MSC + CDC 复合设备</div><div class="line"> * @note</div><div class="line"> * @attention   COYPRIGHT WEYNE</div><div class="line"> */</div><div class="line"></div><div class="line">/* Define to prevent recursive inclusion -------------------------------------*/</div><div class="line">#ifndef __USBD_COMPOSITE_H</div><div class="line">#define __USBD_COMPOSITE_H</div><div class="line"></div><div class="line">#ifdef __cplusplus</div><div class="line"> extern &quot;C&quot; &#123;</div><div class="line">#endif</div><div class="line"></div><div class="line">/* Includes ------------------------------------------------------------------*/</div><div class="line">#include  &quot;usbd_msc.h&quot;</div><div class="line">#include  &quot;usbd_cdc.h&quot;</div><div class="line">#include &quot;usbd_storage_if.h&quot;</div><div class="line">#include &quot;usbd_cdc_if.h&quot;</div><div class="line"></div><div class="line">#define WBVAL(x) (x &amp; 0xFF),((x &gt;&gt; 8) &amp; 0xFF)</div><div class="line">#define DBVAL(x) (x &amp; 0xFF),((x &gt;&gt; 8) &amp; 0xFF),((x &gt;&gt; 16) &amp; 0xFF),((x &gt;&gt; 24) &amp; 0xFF)</div><div class="line"></div><div class="line">#define USBD_IAD_DESC_SIZE           0x08</div><div class="line">#define USBD_IAD_DESCRIPTOR_TYPE     0x0B</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#define USBD_CDC_FIRST_INTERFACE     0          /* CDC FirstInterface */</div><div class="line">#define USBD_CDC_INTERFACE_NUM       2          /* CDC Interface NUM */</div><div class="line"></div><div class="line">#define USBD_CDC_CMD_INTERFACE       0</div><div class="line">#define USBD_CDC_DATA_INTERFACE      1</div><div class="line"></div><div class="line">#define USBD_MSC_FIRST_INTERFACE     2          /* MSC FirstInterface */</div><div class="line">#define USBD_MSC_INTERFACE_NUM       1          /* MSC Interface NUM */</div><div class="line"></div><div class="line">#define USBD_MSC_INTERFACE           2</div><div class="line"></div><div class="line"></div><div class="line">#define MSC_INDATA_NUM              (MSC_EPIN_ADDR &amp; 0x0F)</div><div class="line">#define MSC_OUTDATA_NUM             (MSC_EPOUT_ADDR &amp; 0x0F)</div><div class="line"></div><div class="line">#define CDC_INDATA_NUM              (CDC_IN_EP &amp; 0x0F)</div><div class="line">#define CDC_OUTDATA_NUM             (CDC_OUT_EP &amp; 0x0F)</div><div class="line">#define CDC_OUTCMD_NUM              (CDC_CMD_EP &amp; 0x0F)</div><div class="line"></div><div class="line">#define USBD_COMPOSITE_DESC_SIZE    (9  + 58 + 8 +  32 + 8)</div><div class="line"></div><div class="line"></div><div class="line">extern USBD_ClassTypeDef    USBD_COMPOSITE;</div><div class="line"></div><div class="line">/**</div><div class="line">  * @&#125;</div><div class="line">  */</div><div class="line"></div><div class="line">/**</div><div class="line">  * @&#125;</div><div class="line">  */</div><div class="line"></div><div class="line">#ifdef __cplusplus</div><div class="line">&#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">#endif  /* __USBD_MSC_H */</div><div class="line">/**</div><div class="line">  * @&#125;</div><div class="line">  */</div><div class="line"></div><div class="line">/************************ (C) COPYRIGHT WEYNE *****END OF FILE****/</div></pre></td></tr></table></figure>
<p>注意我这里修改了cube原来在usbd_cdc_if中的fops变量的定义。</p>
<ol>
<li><p>修改  usbd_device.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* init function */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_USB_DEVICE_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* Init Device Library,Add Supported Class and Start the library*/</span></div><div class="line">  USBD_Init(&amp;hUsbDeviceFS, &amp;FS_Desc, DEVICE_FS);</div><div class="line"></div><div class="line">  USBD_RegisterClass(&amp;hUsbDeviceFS, &amp;USBD_COMPOSITE);</div><div class="line"></div><div class="line"> <span class="comment">// USBD_MSC_RegisterStorage(&amp;hUsbDeviceFS, &amp;USBD_Storage_Interface_fops_FS);</span></div><div class="line"></div><div class="line">  USBD_Start(&amp;hUsbDeviceFS);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>修改 usbd_conf.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_MAX_NUM_INTERFACES     3</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_malloc               malloc</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> USBD_free                 free</span></div></pre></td></tr></table></figure>
</li>
<li><p>修改usbd_conf.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  Initializes the Low Level portion of the Device driver.</div><div class="line">  * @param  pdev: Device handle</div><div class="line">  * @retval USBD Status</div><div class="line">  */</div><div class="line"><span class="function">USBD_StatusTypeDef  <span class="title">USBD_LL_Init</span> <span class="params">(USBD_HandleTypeDef *pdev)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* Init USB_IP */</span></div><div class="line">  <span class="comment">/* Link The driver to the stack */</span></div><div class="line">  hpcd_USB_FS.pData = pdev;</div><div class="line">  pdev-&gt;pData = &amp;hpcd_USB_FS;</div><div class="line"></div><div class="line">  hpcd_USB_FS.Instance = USB;</div><div class="line">  hpcd_USB_FS.Init.dev_endpoints = <span class="number">8</span>;</div><div class="line">  hpcd_USB_FS.Init.speed = PCD_SPEED_FULL;</div><div class="line">  hpcd_USB_FS.Init.ep0_mps = DEP0CTL_MPS_8;</div><div class="line">  hpcd_USB_FS.Init.low_power_enable = DISABLE;</div><div class="line">  hpcd_USB_FS.Init.lpm_enable = DISABLE;</div><div class="line">  hpcd_USB_FS.Init.battery_charging_enable = DISABLE;</div><div class="line">  <span class="keyword">if</span> (HAL_PCD_Init(&amp;hpcd_USB_FS) != HAL_OK)</div><div class="line">  &#123;</div><div class="line">    Error_Handler();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , <span class="number">0x00</span> , PCD_SNG_BUF, <span class="number">0x18</span>);</div><div class="line">  HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , <span class="number">0x80</span> , PCD_SNG_BUF, <span class="number">0x58</span>);</div><div class="line">  HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , CDC_IN_EP , PCD_SNG_BUF, <span class="number">0x98</span>);</div><div class="line">  HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , CDC_OUT_EP , PCD_SNG_BUF, <span class="number">0xD8</span>);</div><div class="line">  HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , MSC_EPIN_ADDR , PCD_SNG_BUF, <span class="number">0x98</span>);</div><div class="line">  HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , MSC_EPOUT_ADDR , PCD_SNG_BUF, <span class="number">0xD8</span>);</div><div class="line">  HAL_PCDEx_PMAConfig((PCD_HandleTypeDef*)pdev-&gt;pData , CDC_CMD_EP   , PCD_SNG_BUF, <span class="number">0x118</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> USBD_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>修改完成</p>
<h3 id="安装驱动"><a href="#安装驱动" class="headerlink" title="安装驱动"></a>安装驱动</h3><ol>
<li>安装ST的虚拟串口驱动。插上复合设备后，如果提示找不到驱动，可以采用下面的办法</li>
<li>在设备管理器中找到 STMicroelectronics -&gt; 右键 -&gt; 更新驱动程序软件 -&gt; 浏览计算机以查找驱动<br>程序软件 -&gt; 从计算机的设备驱动程序列表中选择 -&gt; 选择“端口（COM和LPT）”-&gt; 从磁盘安装 -&gt;<br>找到stmcdc.inf的目录并选择stmcdc.inf（一般在C:\Program Files (x86)\STMicroelectronics\Win7）<br>-&gt; 确定执行安装。</li>
</ol>
<p>至此，设备可以枚举成功了，电脑中出现了串口号和U盘。</p>
  
	</div>
		<footer class="article-footer clearfix">


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/STM32/">STM32</a>
</div>



<div class="article-share" id="share">

  <div data-url="weynechen.github.io/2016/10/24/STM32-USB-composite-deveice/" data-title="STM32 USB composite deveice | weyne&#39;s note" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/11/01/work-with-cmake/" title="work with cmake">
  <strong>PREVIOUS:</strong><br/>
  <span>
  work with cmake</span>
</a>
</div>


<div class="next">
<a href="/2016/10/23/qt-in-Linux/"  title="在Ubuntu下编译 Qt程序">
 <strong>NEXT:</strong><br/> 
 <span>在Ubuntu下编译 Qt程序
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#目的"><span class="toc-number">1.</span> <span class="toc-text">目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预备知识"><span class="toc-number">2.</span> <span class="toc-text">预备知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-number">3.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改"><span class="toc-number">4.</span> <span class="toc-text">修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装驱动"><span class="toc-number">4.1.</span> <span class="toc-text">安装驱动</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/QT/" title="QT">QT<sup>2</sup></a></li>
		
			<li><a href="/categories/STM32/" title="STM32">STM32<sup>7</sup></a></li>
		
			<li><a href="/categories/STM8/" title="STM8">STM8<sup>1</sup></a></li>
		
			<li><a href="/categories/笔记/" title="笔记">笔记<sup>4</sup></a></li>
		
			<li><a href="/categories/算法/" title="算法">算法<sup>2</sup></a></li>
		
			<li><a href="/categories/编程工具/" title="编程工具">编程工具<sup>11</sup></a></li>
		
			<li><a href="/categories/通讯接口/" title="通讯接口">通讯接口<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/GraphViz/" title="GraphViz">GraphViz<sup>1</sup></a></li>
		
			<li><a href="/tags/cube/" title="cube">cube<sup>1</sup></a></li>
		
			<li><a href="/tags/usb/" title="usb">usb<sup>1</sup></a></li>
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme fork Pacman © 2016 
		
		<a href="weynechen.github.io" target="_blank" title="weyne">weyne</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"null"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end --> 





  </body>
</html>
